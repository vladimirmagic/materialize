
<!--  Scripts-->
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<script src="bin/materialize.js"></script>
<script src="docs/js/init.js"></script>
<script>
    const svgSprite = document.createElement('div');
	svgSprite.id = 'svg-sprite';
	document.body.append(svgSprite);
	const loaded = () => document.body.classList.add('loaded');
	fetch('dist/defs/svg/sprite.defs.svg', { cache: 'force-cache' })
		.then(response => response.text())
		.then(html => { svgSprite.innerHTML = html; loaded(); })
		.catch(loaded);

	document.addEventListener('DOMContentLoaded', () => {

		/** CHECKOUT */

		$('.__PrivateStripeElement').attr('style', ' ');

		// STEPS
		const checkoutSteps = document.querySelectorAll('.order-step');
		const checkoutStepTabs = document.querySelectorAll('.checkout-step-tab');
		const checkoutStepActive = document.querySelector('input[name="checkout-step"]');
		if (checkoutStepActive && checkoutSteps && checkoutSteps.length && checkoutStepTabs && checkoutStepTabs.length) {
			checkoutSteps.forEach(checkoutStep => {
				if (checkoutStep.dataset && checkoutStep.dataset.step) {
					checkoutStep.addEventListener('click', () => {
						checkoutStepActive.value = checkoutStep.dataset.step;
						checkoutStepTabs.forEach(checkoutStepTab => checkoutStepTab.style.display = 'none');
						const checkoutStepTab = document.getElementById('checkout-step-tab-' + checkoutStep.dataset.step);
						if (checkoutStepTab) {
							checkoutStepTab.style.display = 'block';
							setTimeout(() => scrollToError(checkoutStepTab), 100); // wait display
						}
					});
				}
			});

			const checkoutStepTab = document.getElementById('checkout-step-tab-' + checkoutStepActive.value);
			if (checkoutStepTab) {
				checkoutStepTab.style.display = 'block';
				setTimeout(() => scrollToError(checkoutStepTab), 100); // wait display
			}
		}

		// ERRORS
		function scrollToError (container = document) {
			const error = container.querySelector('main .error');
			if (error) error.scrollIntoView({behavior: 'smooth', block: 'center'});
		}
		scrollToError();

		// SHIPPING
		const shippingRequired = document.querySelectorAll('.checkout-shipping-required');
		const shippingRequiredChecked = document.querySelectorAll('.checkout-shipping-required:checked');
		if (shippingRequired && shippingRequired.length && shippingRequiredChecked && shippingRequiredChecked.length) {
			function isShippingRequired (input) {
				const tabs = document.querySelectorAll('.' + input.name + '-tab');
				if (tabs && tabs.length) {
					tabs.forEach(tab => tab.style.display = 'none');
					const tab = document.querySelector('#' + input.name + '-tab-' + input.value);
					if (tab) tab.style.display = 'block';
				}
				const address = document.querySelector('.checkout-shipping-address');
				const shippingRequiredChecked = document.querySelectorAll('.checkout-shipping-required:checked');
				if (address && shippingRequiredChecked && shippingRequiredChecked.length) { // show address if any part requires shipping
					let isRequired = 0;
					shippingRequiredChecked.forEach(input => isRequired += Number(input.value));
					address.style.display = isRequired ? 'block' : 'none';
				}
			}
			shippingRequiredChecked.forEach(input => {
				isShippingRequired(input);
			});
			shippingRequired.forEach(input => {
				input.addEventListener('change', () => isShippingRequired(input));
			});
		}

		// PAYMENTS PLAN
		const paymentsPlans = document.querySelectorAll('.checkout-payments-plan input');
		if (paymentsPlans && paymentsPlans.length) {
			paymentsPlans.forEach(paymentsPlan => {
				if (paymentsPlan.dataset && paymentsPlan.dataset.tab) {
					paymentsPlan.addEventListener('change', () => {
						const container = paymentsPlan.closest('.checkout-payments-plan');
						if (container) {
							const paymentsPlanTabs = container.querySelectorAll('.payments-plan-tab');
							if (paymentsPlanTabs && paymentsPlanTabs.length) {
								paymentsPlanTabs.forEach(paymentsPlanTab => paymentsPlanTab.style.display = 'none');
								const paymentsPlanTab = document.querySelector(paymentsPlan.dataset.tab);
								if (paymentsPlanTab) paymentsPlanTab.style.display = 'block';
							}
						}
					});
				}
			});
		}

		const paymentsPlansChecked = document.querySelectorAll('.checkout-payments-plan input:checked');
		if (paymentsPlansChecked && paymentsPlansChecked.length) {
			paymentsPlansChecked.forEach(paymentsPlan => {
				if (paymentsPlan.dataset && paymentsPlan.dataset.tab) {
					const paymentsPlanTab = document.querySelector(paymentsPlan.dataset.tab);
					if (paymentsPlanTab) paymentsPlanTab.style.display = 'block';
				}
			});
		}

		// PAYMENT TYPE
		const paymentTypes = document.querySelectorAll('input[name="checkout-payment-type"]');
		const paymentTypeTabs = document.querySelectorAll('.checkout-payment-type');
		if (paymentTypes && paymentTypes.length && paymentTypeTabs && paymentTypeTabs.length) {
			paymentTypes.forEach(paymentType => {
				if (paymentType.dataset && paymentType.dataset.tab) {
					paymentType.addEventListener('change', () => {
						paymentTypeTabs.forEach(paymentTypeTab => paymentTypeTab.style.display = 'none');
						const paymentTypeTab = document.querySelector(paymentType.dataset.tab);
						if (paymentTypeTab) paymentTypeTab.style.display = 'block';
					});
				}
			});
			const paymentTypeChecked = document.querySelector('input[name="checkout-payment-type"]:checked');
			if (paymentTypeChecked && paymentTypeChecked.dataset && paymentTypeChecked.dataset.tab) {
				const paymentTypeTab = document.querySelector(paymentTypeChecked.dataset.tab);
				if (paymentTypeTab) paymentTypeTab.style.display = 'block';
			}
		}

		// PAYMENT CARD
		const paymentCard = document.querySelector('select[name="checkout-payment-card"]');
		const paymentCardNew = document.querySelector('.checkout-payment-card-new__container');
		if (paymentCard && paymentCardNew) {
			function isPaymentCardNew () {
				paymentCardNew.style.display = (paymentCard.value == 0) ? 'block' : 'none';
			}
			paymentCard.addEventListener('change', isPaymentCardNew);
			isPaymentCardNew();
		}

		// BILLING ADDRESS
		const billingAddressCheckbox = document.querySelector('input[name="checkout-billing-address"]');
		const billingAddressForm = document.querySelector('.checkout-billing-address-form');
		if (billingAddressCheckbox && billingAddressForm) {
			function checkoutBillingAddress () {
				billingAddressForm.style.display = billingAddressCheckbox.checked ? 'none' : 'block';
			}
			billingAddressCheckbox.addEventListener('change', checkoutBillingAddress);
			checkoutBillingAddress();
		}

		// RESALE CERTIFICATE
		const resaleСertificateCheckbox = document.querySelector('input[name="checkout-resale-certificate"]');
		const resaleСertificateForm = document.querySelector('.checkout-resale-certificate-form');
		if (resaleСertificateCheckbox && resaleСertificateForm) {
			function checkoutResaleСertificate () {
				resaleСertificateForm.style.display = resaleСertificateCheckbox.checked ? 'block' : 'none';
			}
			resaleСertificateCheckbox.addEventListener('change', checkoutResaleСertificate);
			checkoutResaleСertificate();
		}

		// REGISTERED BUSINESS
		const businessCheckbox = document.querySelector('input[name="checkout-business"]');
		const businessForm = document.querySelector('.checkout-business-form');
		if (businessCheckbox && businessForm) {
			function isRegisteredBusiness () {
				businessForm.style.display = businessCheckbox.checked ? 'block' : 'none';
			}
			businessCheckbox.addEventListener('change', isRegisteredBusiness);
			isRegisteredBusiness();
		}

		/** ACCOUNT */

		// SHIPPING ADDRESS
		const shippingAddressCheckbox = document.querySelector('input[name="shippingAsBilling"]');
		const shippingAddressForm = document.querySelector('.account-shipping-address-form');
		if (shippingAddressCheckbox && shippingAddressForm) {
			function accountShippingAddress () {
				shippingAddressForm.style.display = shippingAddressCheckbox.checked ? 'none' : 'block';
			}
			shippingAddressCheckbox.addEventListener('change', accountShippingAddress);
			accountShippingAddress();
		}

		// WATCHLIST
		const watchlistHearts = document.querySelectorAll('.account__watchlist .heart');
		const watchlistForm = document.querySelector('.modal-watchlist__buttons');
		if (watchlistHearts && watchlistHearts.length && watchlistForm) {
			watchlistHearts.forEach(watchlistHeart => {
				if (watchlistHeart.dataset && watchlistHeart.dataset.href) {
					watchlistHeart.addEventListener('click', () => {
						watchlistForm.setAttribute('action', watchlistHeart.dataset.href);
					});
				}
			});
		}

		/** REGISTER */
		$('#modal-password').modal();
		$('#modal-register').modal();
		$('#modal-signin').modal({ // load form on modal open
            onOpenStart: function (el) {
				// el.classList.add('sync');
                // $.post('#')
				// .done(data => {
				// 	$('.modal-signin-form').html(data);
				// 	M.updateTextFields();
				// })
				// .fail(data => {
				// 	$('.modal-signin-form').html(data);
				// })
				// .always(data => {
				// 	$('.modal-signin-form').html(data.responseText);
				// 	M.updateTextFields();
				// 	el.classList.remove('sync');
				// });
            }
        });
		const modalRegisterForm = document.querySelector('.modal-register-form');
		if (modalRegisterForm) {
			modalRegisterForm.addEventListener('submit', (e) => {
				e.preventDefault();
				modalRegisterForm.classList.add('sync');
				fetch(modalRegisterForm.action)
					.then(response => response.text())
					.then(html => {
						// window.location.reload();
						console.log('ok: ', html);
					})
					.catch(html => console.log('error: ', html))
					.finally(() => {
						modalRegisterForm.classList.remove('sync');
					});
			});
		}

		$('#modal-payment-plan').modal({
			onOpenEnd: () => {
				$($('.modal-payment-plan__months-buttons input:checked').data('tab')).show();
			}
		});

		$('.modal-payment-plan__months-buttons input').on('change', function () {
			$('.modal-payment-plan__tab').hide();
			$($(this).data('tab')).show();
		});

		$('.modal-shipping-quote-form').submit(function (e) {
            e.preventDefault();
            this.classList.add('sync');
            $.post(
                this.action,
                $(this).serialize(),
            )
                .done(data => {
                    this.innerHTML = data;
					M.updateTextFields();
                })
                .fail(data => {
                    if (data && data.statusText) this.innerHTML = data.statusText;
                })
                .always(data => {
                    this.classList.remove('sync');
                });
        });

		$('.header__bag').dropdown({ // load form on open
			alignment: 'right',
			onOpenStart: function (el) {
				el.classList.add('sync');
				const $form = $('#modal-bag').find('.modal-form');
				$.get('/ajax/rest.action?actions=productBasket')
					.done(data => {
						$form.html(data);
					})
					.fail(data => {
						if (data && data.statusText) $form.html(data.statusText);
					})
					.always(data => {
						el.classList.remove('sync');
					});
			}
		});
	});
</script>

<!-- Click for Blog listing categories on cards -->
<script>
    jQuery(document).ready(() => {
        $('.card-blog').on('click', function(event) {
            const fakeUrl = $(event.target).data('href');
            if(fakeUrl) event.preventDefault();
            window.location.href = fakeUrl;
        });
    });
</script>
<!-- Click for Blog listing menu categories -->
<script>
    jQuery(document).ready(() => {
		// это только для блога
        // $('.filters__select-category select').on('change', function(event) {
        //     const link = event.target.value;
        //     window.location.href = link;
        // });
    });
</script>
<!-- Live search for FAQs -->
<script>
    jQuery(document).ready(() => {
        function changeCategory (category) {
            if (category == 0) {
                $('.faq__item').show();
            } else {
                $('.faq__item:not(.category-' + category + ')').hide();
                $('.category-' + category).show();
            }
        }

        $('.filters__menu-category').on('click', function(event) {
            $('.filters__menu-category').removeClass('active');
            $(this).addClass('active');
            $('.filters__select-category select').val($(this).data('category'));
            changeCategory($(this).data('category'));
        });

        $('.filters__select-category select').on('change', function(event) {
            changeCategory($(this).val());
        });

        try {
            let debounceTimer = null; 
            function Search(event) {
                if (event.key === 'Enter') {
                    $('.faq__search-suggester').addClass('faq__search-suggester--init');
                    return;
                }
                
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(function(){
                    var searchValue = $('.input-field--faq-search input').val();
                    var customFilter = new RegExp(searchValue, 'ig');
                    var replacedString = "<span class='faq__highlight'>$&</span>";
                    $('.faq__content').find('.faq__highlight').contents().unwrap();
                    
                    $('.faq__collapsible-header-text').each(function() {
                        if(searchValue.length > 1){
                            const content = $(this).text().replace(customFilter, replacedString);
                            $(this).html(content);
                        }
                    });
                    
                    $('.collapsible-body').each(function() {
                        if(searchValue.length > 1){
                            const content = $(this).text().replace(customFilter, replacedString);
                            $(this).html(content);
                        }
                    });
                }, 300);
                
                $('.faq__search-suggester').removeClass('faq__search-suggester--init');
                
                const results = [];
                const search = event.target.value.toLowerCase();
                const category = $('.filters__select-category select').val();
                $('.faq__collapsible-header').each((idx, el) => {
                    const headerString = $(el).text();
                    const bodyString = $('.faq__collapsible-body').eq(idx).text();
                    const $parentEl = $(el).closest('.faq__item');
                    
                    const isCategory = category == 0 || $parentEl.hasClass('category-' + category);
                    const isMatch = bodyString.toLowerCase().includes(search) || headerString.toLowerCase().includes(search);
                    const isShow = isCategory && isMatch;
                    
                    $parentEl.toggle(isShow);
                    if (isShow && search) {
                        results.push({idx, headerString});
                    }
                });
                
                $('.faq__search-suggester').text('');
                results.forEach((suggest) => {
                    const $clone = $view.clone();
                    $clone.data(suggest);
                    $clone.find('.faq__search-suggester__item-text').text(suggest.headerString);
                    $('.faq__search-suggester').append($clone);
                });

                const isEmpty = results.length === 0 && search !== '';
                $('.faq__search-suggester').toggleClass('faq__search-suggester--empty', isEmpty);
            }

            const $span = $('<span/>', {class: 'faq__search-suggester__item-text'});
            const $link = $('<a/>', {class: 'faq__search-suggester__item p-s'});
            const $view = $link.append($span);

            $('.faq__search-suggester').on('click', (event) => {
                const target = event.target;
                const linkData = $(target).closest('a').data();
                
                $('.faq__collapsible li.active .collapsible-header').click();
                $('.faq__collapsible li .faq__collapsible-header').get(linkData.idx).click();

                setTimeout(function() {
                    $('.faq__collapsible li').get(linkData.idx).scrollIntoView({behavior: 'smooth'});
                }, 300);

            });

            $('.faq__search-container input').on('keyup', Search);
            $('.faq__search-container input').on('click', Search);
            
            
            $('.faq__search-container input').on('focusout', function(event) {
                setTimeout(function() {
                    $('.faq__search-suggester').addClass('faq__search-suggester--init');
                }, 300);
            });
        } catch (e) {
            console.error(e);
        }
    });
</script>
